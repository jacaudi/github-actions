name: GoReleaser
# Reusable workflow for Go project releases using GoReleaser
# Builds multi-platform binaries and creates GitHub releases

on:
  workflow_call:
    inputs:
      # Go configuration
      go-version:
        description: 'Go version to use for building'
        required: false
        type: string
        default: 'stable'

      # GoReleaser configuration
      goreleaser-version:
        description: 'GoReleaser version to use'
        required: false
        type: string
        default: 'latest'
      goreleaser-config:
        description: 'Path to GoReleaser configuration file'
        required: false
        type: string
        default: '.goreleaser.yml'
      goreleaser-args:
        description: 'Additional GoReleaser arguments'
        required: false
        type: string
        default: ''

      # Release configuration
      release-tag:
        description: 'Tag name for the release (defaults to github.ref_name)'
        required: false
        type: string
        default: ''
      dry-run:
        description: 'Run in dry-run mode (no release created)'
        required: false
        type: boolean
        default: false
      snapshot:
        description: 'Create a snapshot release (version not required)'
        required: false
        type: boolean
        default: false

      # Runner configuration
      runs-on:
        description: 'Runner label to use'
        required: false
        type: string
        default: 'ubuntu-latest'

    secrets:
      github-token:
        description: 'GitHub token for creating releases (defaults to GITHUB_TOKEN)'
        required: false

    outputs:
      release-url:
        description: 'The URL of the created release'
        value: ${{ jobs.goreleaser.outputs.release-url }}
      release-tag:
        description: 'The tag name of the release'
        value: ${{ jobs.goreleaser.outputs.release-tag }}
      version:
        description: 'The version that was released'
        value: ${{ jobs.goreleaser.outputs.version }}
      artifacts:
        description: 'JSON array of built artifacts'
        value: ${{ jobs.goreleaser.outputs.artifacts }}
      metadata:
        description: 'GoReleaser metadata JSON'
        value: ${{ jobs.goreleaser.outputs.metadata }}

jobs:
  goreleaser:
    name: GoReleaser
    runs-on: ${{ inputs.runs-on }}
    permissions:
      contents: write
      packages: write
    outputs:
      release-url: ${{ steps.release-info.outputs.release-url }}
      release-tag: ${{ steps.release-info.outputs.release-tag }}
      version: ${{ steps.release-info.outputs.version }}
      artifacts: ${{ steps.goreleaser.outputs.artifacts }}
      metadata: ${{ steps.goreleaser.outputs.metadata }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine Release Tag
        id: tag
        run: |
          TAG="${{ inputs.release-tag }}"

          if [[ -z "$TAG" ]]; then
            TAG="${{ github.ref_name }}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ inputs.go-version }}

      - name: Download Dependencies
        run: go mod download

      - name: Build GoReleaser Args
        id: args
        run: |
          ARGS="release --clean"

          # Add dry-run flag
          if [[ "${{ inputs.dry-run }}" == "true" ]]; then
            ARGS="$ARGS --skip=publish"
            echo "Running in dry-run mode (skip publish)"
          fi

          # Add snapshot flag
          if [[ "${{ inputs.snapshot }}" == "true" ]]; then
            ARGS="$ARGS --snapshot"
            echo "Running in snapshot mode"
          fi

          # Add custom args
          if [[ -n "${{ inputs.goreleaser-args }}" ]]; then
            ARGS="$ARGS ${{ inputs.goreleaser-args }}"
          fi

          echo "args=$ARGS" >> $GITHUB_OUTPUT
          echo "GoReleaser args: $ARGS"

      - name: Run GoReleaser
        id: goreleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: ${{ inputs.goreleaser-version }}
          args: ${{ steps.args.outputs.args }}
        env:
          GITHUB_TOKEN: ${{ secrets.github-token || github.token }}
          GORELEASER_CONFIG: ${{ inputs.goreleaser-config }}

      - name: Get Release Info
        id: release-info
        if: ${{ !inputs.dry-run && !inputs.snapshot }}
        env:
          GH_TOKEN: ${{ secrets.github-token || github.token }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"

          # Get release URL
          RELEASE_URL=$(gh release view "$TAG" --json htmlUrl -q '.htmlUrl' 2>/dev/null || echo "")

          # Extract version from tag (remove 'v' prefix if present)
          VERSION="${TAG#v}"

          echo "release-url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "release-tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "Release URL: $RELEASE_URL"
          echo "Release Tag: $TAG"
          echo "Version: $VERSION"

      - name: Generate Summary
        if: always()
        run: |
          echo "## GoReleaser Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Mode indicator
          if [[ "${{ inputs.dry-run }}" == "true" ]]; then
            echo ":test_tube: **Dry Run Mode** - No release was published" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ inputs.snapshot }}" == "true" ]]; then
            echo ":camera: **Snapshot Mode** - Development build created" >> $GITHUB_STEP_SUMMARY
          else
            RELEASE_URL="${{ steps.release-info.outputs.release-url }}"
            if [[ -n "$RELEASE_URL" ]]; then
              echo ":rocket: **Release Published Successfully**" >> $GITHUB_STEP_SUMMARY
            else
              echo ":warning: **Release Status Unknown**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Go Version | \`${{ inputs.go-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| GoReleaser Version | \`${{ inputs.goreleaser-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Config File | \`${{ inputs.goreleaser-config }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ steps.tag.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY

          # Release info
          if [[ "${{ inputs.dry-run }}" != "true" && "${{ inputs.snapshot }}" != "true" ]]; then
            RELEASE_URL="${{ steps.release-info.outputs.release-url }}"
            VERSION="${{ steps.release-info.outputs.version }}"

            if [[ -n "$RELEASE_URL" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Release" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Version | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
              echo "| URL | [View Release](${RELEASE_URL}) |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Artifacts info from GoReleaser output
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -f dist/artifacts.json ]]; then
            echo "Built artifacts:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            jq -r '.[] | select(.type == "Archive" or .type == "Binary") | "- \(.name) (\(.goos)/\(.goarch))"' dist/artifacts.json 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "See release for full artifact list" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Artifact details available in the release." >> $GITHUB_STEP_SUMMARY
          fi
