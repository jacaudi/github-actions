name: CI/CD
# Self-release pipeline for this GitHub Actions repository
#
# Pipeline stages:
# 1. Lint - Validate YAML workflow files
# 2. Release - Auto-version, tag, and release based on Conventional Commits (main branch only)
#
# This workflow "dogfoods" the reusable workflows in this repository
# Uses go-semantic-release for automatic versioning with native feat! support

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  # ===========================================================================
  # Stage 1: Lint
  # ===========================================================================
  lint:
    name: Lint
    uses: ./.github/workflows/lint.yml
    with:
      yaml: true
      yamllint-config: .yamllint.yml
      # Workflows are YAML files, so we lint them
      # No other linters needed for a workflows-only repo

  # ===========================================================================
  # Stage 2: Semantic Release (auto-version, tag, and release on main branch)
  # ===========================================================================
  release:
    name: Release
    needs: [lint]
    # Only run on main branch pushes, not PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/semantic-release.yml
    with:
      use-github-app: true
      allow-initial-development-versions: true
    secrets:
      app-id: ${{ secrets.APP_ID }}
      app-private-key: ${{ secrets.APP_PRIVATE_KEY }}

  # ===========================================================================
  # Pipeline Summary
  # ===========================================================================
  summary:
    name: Pipeline Report
    needs: [lint, release]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push'
    steps:
      - name: Pipeline Summary
        run: |
          echo "## GitHub Actions CI/CD Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Stage results
          echo "### Pipeline Stages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Lint
          if [[ "${{ needs.lint.result }}" == "success" ]]; then
            echo "| Lint | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Lint | :x: ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # Release
          RELEASED="${{ needs.release.outputs.new-release-published }}"
          VERSION="${{ needs.release.outputs.new-release-version }}"
          if [[ "${{ needs.release.result }}" == "skipped" ]]; then
            echo "| Release | :fast_forward: Skipped (PR) |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$RELEASED" == "true" ]]; then
            echo "| Release | :rocket: ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.release.result }}" == "success" ]]; then
            echo "| Release | :information_source: No release needed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Release | :x: ${{ needs.release.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

          # Release details
          if [[ "$RELEASED" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Release Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Release:** [View on GitHub](https://github.com/${{ github.repository }}/releases/tag/${VERSION})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Usage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Reference this release in your workflows:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
            echo "uses: ${{ github.repository }}/.github/workflows/lint.yml@${VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
