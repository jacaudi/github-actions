name: Test go-semantic-release
# Test workflow to validate go-semantic-release behavior
# This workflow runs on the refactor/semantic-release-research branch only

on:
  push:
    branches:
      - refactor/semantic-release-research
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  test-go-semantic-release:
    name: Test Semantic Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Validate git history
        run: |
          echo "Checking git history..."
          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
          TAG_COUNT=$(git tag -l | wc -l | tr -d ' ')

          echo "Total commits: ${COMMIT_COUNT}"
          echo "Total tags: ${TAG_COUNT}"

          # List recent commits for visibility
          echo ""
          echo "Recent commits:"
          git log --oneline -10 || true

          # List existing tags
          if [[ "${TAG_COUNT}" != "0" ]]; then
            echo ""
            echo "Existing version tags:"
            git tag -l 'v*' --sort=-v:refname | head -5 || true
          fi

      - name: Download go-semantic-release
        run: |
          curl -SL https://get-release.xyz/semantic-release/linux/amd64 -o ./semantic-release && chmod +x ./semantic-release

      - name: Run go-semantic-release (dry-run with output)
        id: semrel
        run: |
          ./semantic-release --dry --allow-initial-development-versions --changelog .changelog.md 2>&1 | tee semrel.log

          # Check if release would be created
          if grep -q "new version:" semrel.log; then
            NEW_VERSION=$(grep "new version:" semrel.log | awk '{print $NF}')
            echo "new_release_published=true" >> $GITHUB_OUTPUT
            echo "new_release_version=$NEW_VERSION" >> $GITHUB_OUTPUT

            # Parse version parts
            VERSION_CLEAN=$(echo "$NEW_VERSION" | sed 's/^v//')
            MAJOR=$(echo "$VERSION_CLEAN" | cut -d. -f1)
            MINOR=$(echo "$VERSION_CLEAN" | cut -d. -f2)
            PATCH=$(echo "$VERSION_CLEAN" | cut -d. -f3)

            echo "new_release_major_version=$MAJOR" >> $GITHUB_OUTPUT
            echo "new_release_minor_version=$MINOR" >> $GITHUB_OUTPUT
            echo "new_release_patch_version=$PATCH" >> $GITHUB_OUTPUT

            # Capture changelog if it exists
            if [ -f .changelog.md ]; then
              echo "changelog<<EOF" >> $GITHUB_OUTPUT
              cat .changelog.md >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            echo "new_release_published=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display results
        if: always()
        run: |
          echo "## go-semantic-release Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.semrel.outputs.new_release_published }}" == "true" ]]; then
            echo "✅ **Would create new release**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Version | \`${{ steps.semrel.outputs.new_release_version }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Major | \`${{ steps.semrel.outputs.new_release_major_version }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Minor | \`${{ steps.semrel.outputs.new_release_minor_version }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Patch | \`${{ steps.semrel.outputs.new_release_patch_version }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changelog" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f .changelog.md ]; then
              cat .changelog.md >> $GITHUB_STEP_SUMMARY
            else
              echo "_Changelog file not generated_" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ **No release needed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No qualifying commits found since last release." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Compare with current version
        run: |
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -1 || echo "none")
          echo "Current latest tag: ${LATEST_TAG}"
          echo "Would create: ${{ steps.semrel.outputs.new_release_version || 'no release' }}"

          if [[ "${{ steps.semrel.outputs.new_release_published }}" == "true" ]]; then
            echo ""
            echo "Version bump detected!"
            echo "From: ${LATEST_TAG}"
            echo "To: ${{ steps.semrel.outputs.new_release_version }}"
          fi
