name: Lint
# Multi-language linting reusable workflow supporting Python, Go, Shell, YAML, and Helm

on:
  workflow_call:
    inputs:
      python:
        description: 'Enable Python linting with ruff'
        required: false
        type: boolean
        default: false
      python-version:
        description: 'Python version to use for ruff'
        required: false
        type: string
        default: '3.12'
      ruff-version:
        description: 'Ruff version to install (empty for latest)'
        required: false
        type: string
        default: ''
      ruff-args:
        description: 'Additional arguments to pass to ruff check'
        required: false
        type: string
        default: '.'
      go:
        description: 'Enable Go linting with golangci-lint'
        required: false
        type: boolean
        default: false
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: 'stable'
      golangci-lint-version:
        description: 'golangci-lint version to install'
        required: false
        type: string
        default: 'latest'
      golangci-lint-args:
        description: 'Additional arguments to pass to golangci-lint'
        required: false
        type: string
        default: ''
      shell:
        description: 'Enable shell script linting with shellcheck'
        required: false
        type: boolean
        default: false
      shellcheck-version:
        description: 'ShellCheck version to use'
        required: false
        type: string
        default: 'stable'
      shellcheck-paths:
        description: 'Paths to check for shell scripts (space-separated)'
        required: false
        type: string
        default: '.'
      shellcheck-args:
        description: 'Additional arguments to pass to shellcheck'
        required: false
        type: string
        default: ''
      yaml:
        description: 'Enable YAML linting with yamllint'
        required: false
        type: boolean
        default: false
      yamllint-config:
        description: 'Path to yamllint config file'
        required: false
        type: string
        default: ''
      yamllint-args:
        description: 'Additional arguments to pass to yamllint'
        required: false
        type: string
        default: '.'
      helm:
        description: 'Enable Helm chart linting'
        required: false
        type: boolean
        default: false
      helm-chart-path:
        description: 'Path to Helm chart(s) to lint'
        required: false
        type: string
        default: 'charts/'
      helm-args:
        description: 'Additional arguments to pass to helm lint'
        required: false
        type: string
        default: ''
      json:
        description: 'Enable JSON linting with jq'
        required: false
        type: boolean
        default: false
      json-paths:
        description: 'Paths/globs to check for JSON files (space-separated)'
        required: false
        type: string
        default: '.'
      json-exclude:
        description: 'Patterns to exclude from JSON linting (space-separated)'
        required: false
        type: string
        default: 'node_modules .git'
      working-directory:
        description: 'Working directory for all lint commands'
        required: false
        type: string
        default: '.'
      fail-fast:
        description: 'Stop on first linter failure'
        required: false
        type: boolean
        default: true
      upload-artifact:
        description: 'Upload lint results as artifact'
        required: false
        type: boolean
        default: true
      artifact-name:
        description: 'Name for lint result artifacts'
        required: false
        type: string
        default: 'lint-results'
      artifact-retention-days:
        description: 'Number of days to retain lint artifacts'
        required: false
        type: number
        default: 7
    outputs:
      python-status:
        description: 'Python lint result: success, failure, or skipped'
        value: ${{ jobs.lint.outputs.python-status }}
      go-status:
        description: 'Go lint result: success, failure, or skipped'
        value: ${{ jobs.lint.outputs.go-status }}
      shell-status:
        description: 'Shell lint result: success, failure, or skipped'
        value: ${{ jobs.lint.outputs.shell-status }}
      yaml-status:
        description: 'YAML lint result: success, failure, or skipped'
        value: ${{ jobs.lint.outputs.yaml-status }}
      helm-status:
        description: 'Helm lint result: success, failure, or skipped'
        value: ${{ jobs.lint.outputs.helm-status }}
      json-status:
        description: 'JSON lint result: success, failure, or skipped'
        value: ${{ jobs.lint.outputs.json-status }}
      overall-status:
        description: 'Overall lint result: success or failure'
        value: ${{ jobs.lint.outputs.overall-status }}

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-linters: ${{ steps.set-matrix.outputs.has-linters }}
    steps:
      - name: Build linter matrix
        id: set-matrix
        run: |
          LINTERS="[]"

          if [[ "${{ inputs.python }}" == "true" ]]; then
            LINTERS=$(echo "$LINTERS" | jq -c '. + ["python"]')
          fi
          if [[ "${{ inputs.go }}" == "true" ]]; then
            LINTERS=$(echo "$LINTERS" | jq -c '. + ["go"]')
          fi
          if [[ "${{ inputs.shell }}" == "true" ]]; then
            LINTERS=$(echo "$LINTERS" | jq -c '. + ["shell"]')
          fi
          if [[ "${{ inputs.yaml }}" == "true" ]]; then
            LINTERS=$(echo "$LINTERS" | jq -c '. + ["yaml"]')
          fi
          if [[ "${{ inputs.helm }}" == "true" ]]; then
            LINTERS=$(echo "$LINTERS" | jq -c '. + ["helm"]')
          fi
          if [[ "${{ inputs.json }}" == "true" ]]; then
            LINTERS=$(echo "$LINTERS" | jq -c '. + ["json"]')
          fi

          echo "matrix={\"linter\":$LINTERS}" >> $GITHUB_OUTPUT

          if [[ "$LINTERS" == "[]" ]]; then
            echo "has-linters=false" >> $GITHUB_OUTPUT
          else
            echo "has-linters=true" >> $GITHUB_OUTPUT
          fi

          echo "Generated matrix: {\"linter\":$LINTERS}"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    outputs:
      python-status: ${{ steps.python-lint.outcome || 'skipped' }}
      go-status: ${{ steps.go-lint.outcome || 'skipped' }}
      shell-status: ${{ steps.shell-lint.outcome || 'skipped' }}
      yaml-status: ${{ steps.yaml-lint.outcome || 'skipped' }}
      helm-status: ${{ steps.helm-lint.outcome || 'skipped' }}
      json-status: ${{ steps.json-lint.outcome || 'skipped' }}
      overall-status: ${{ steps.summary.outputs.status }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create results directory
        run: mkdir -p .lint-results

      # Python Linting with Ruff
      - name: Set up Python
        if: inputs.python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install Ruff
        if: inputs.python
        run: |
          if [[ -n "${{ inputs.ruff-version }}" ]]; then
            pip install ruff==${{ inputs.ruff-version }}
          else
            pip install ruff
          fi

      - name: Run Ruff
        id: python-lint
        if: inputs.python
        continue-on-error: ${{ !inputs.fail-fast }}
        run: |
          echo "::group::Ruff Output"
          # Output JSON for artifacts and console for visibility
          ruff check --output-format json ${{ inputs.ruff-args }} > .lint-results/ruff.json 2>&1 || true
          ruff check ${{ inputs.ruff-args }}
          echo "::endgroup::"

      # Go Linting with golangci-lint
      - name: Set up Go
        if: inputs.go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ inputs.go-version }}

      - name: Run golangci-lint
        id: go-lint
        if: inputs.go
        uses: golangci/golangci-lint-action@v9
        continue-on-error: ${{ !inputs.fail-fast }}
        with:
          version: ${{ inputs.golangci-lint-version }}
          args: ${{ inputs.golangci-lint-args }}
          working-directory: ${{ inputs.working-directory }}

      - name: Save golangci-lint JSON output
        if: inputs.go && always()
        continue-on-error: true
        run: |
          golangci-lint run --out-format json ${{ inputs.golangci-lint-args }} > .lint-results/golangci-lint.json 2>&1 || true

      # Shell Linting with ShellCheck
      - name: Run ShellCheck
        id: shell-lint
        if: inputs.shell
        uses: ludeeus/action-shellcheck@2.0.0
        continue-on-error: ${{ !inputs.fail-fast }}
        with:
          version: ${{ inputs.shellcheck-version }}
          scandir: ${{ inputs.shellcheck-paths }}
          additional_files: ${{ inputs.shellcheck-args }}

      - name: Save ShellCheck JSON output
        if: inputs.shell && always()
        continue-on-error: true
        run: |
          # Find shell scripts and run shellcheck with JSON output
          find ${{ inputs.shellcheck-paths }} -type f \( -name "*.sh" -o -name "*.bash" \) -print0 2>/dev/null | \
            xargs -0 shellcheck --format=json ${{ inputs.shellcheck-args }} > .lint-results/shellcheck.json 2>&1 || true

      # YAML Linting with yamllint
      - name: Install yamllint
        if: inputs.yaml
        run: pip install yamllint

      - name: Run yamllint
        id: yaml-lint
        if: inputs.yaml
        continue-on-error: ${{ !inputs.fail-fast }}
        run: |
          echo "::group::yamllint Output"
          if [[ -n "${{ inputs.yamllint-config }}" ]]; then
            # Output parseable format for artifacts
            yamllint -f parsable -c "${{ inputs.yamllint-config }}" ${{ inputs.yamllint-args }} > .lint-results/yamllint.txt 2>&1 || true
            # Run again for console output
            yamllint -c "${{ inputs.yamllint-config }}" ${{ inputs.yamllint-args }}
          else
            # Output parseable format for artifacts
            yamllint -f parsable ${{ inputs.yamllint-args }} > .lint-results/yamllint.txt 2>&1 || true
            # Run again for console output
            yamllint ${{ inputs.yamllint-args }}
          fi
          echo "::endgroup::"

      # Helm Linting
      - name: Set up Helm
        if: inputs.helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Run Helm lint
        id: helm-lint
        if: inputs.helm
        continue-on-error: ${{ !inputs.fail-fast }}
        run: |
          echo "::group::Helm Lint Output"
          # Handle both single chart and multiple charts in directory
          CHART_PATH="${{ inputs.helm-chart-path }}"
          if [[ -f "${CHART_PATH}/Chart.yaml" ]]; then
            helm lint "${CHART_PATH}" ${{ inputs.helm-args }} 2>&1 | tee .lint-results/helm-lint.txt
          else
            # Find all charts in the directory
            found_charts=0
            for chart in "${CHART_PATH}"/*/Chart.yaml; do
              if [[ -f "$chart" ]]; then
                chart_dir=$(dirname "$chart")
                echo "Linting chart: $chart_dir"
                helm lint "$chart_dir" ${{ inputs.helm-args }} 2>&1 | tee -a .lint-results/helm-lint.txt
                found_charts=1
              fi
            done
            if [[ $found_charts -eq 0 ]]; then
              echo "::warning::No Helm charts found in ${CHART_PATH}"
            fi
          fi
          echo "::endgroup::"

      # JSON Linting with jq
      - name: Run JSON lint
        id: json-lint
        if: inputs.json
        continue-on-error: ${{ !inputs.fail-fast }}
        run: |
          echo "::group::JSON Lint Output"

          # Build exclude pattern for find
          EXCLUDE_ARGS=""
          for pattern in ${{ inputs.json-exclude }}; do
            EXCLUDE_ARGS="${EXCLUDE_ARGS} -path '*/${pattern}/*' -prune -o"
          done

          # Find and validate JSON files
          FAILED=0
          CHECKED=0
          RESULTS="[]"

          while IFS= read -r -d '' file; do
            CHECKED=$((CHECKED + 1))
            if ERROR=$(jq empty "$file" 2>&1); then
              echo "OK: $file"
            else
              echo "FAIL: $file"
              echo "  Error: $ERROR"
              FAILED=$((FAILED + 1))
              RESULTS=$(echo "$RESULTS" | jq --arg file "$file" --arg error "$ERROR" '. + [{"file": $file, "error": $error}]')
            fi
          done < <(eval "find ${{ inputs.json-paths }} ${EXCLUDE_ARGS} -type f -name '*.json' -print0 2>/dev/null")

          # Save results
          echo "$RESULTS" > .lint-results/json-lint.json

          echo ""
          echo "Checked ${CHECKED} JSON files, ${FAILED} failed"

          echo "::endgroup::"

          if [[ ${FAILED} -gt 0 ]]; then
            echo "::error::${FAILED} JSON file(s) contain invalid syntax"
            exit 1
          fi

      # Upload Lint Artifacts
      - name: List lint results
        if: always()
        run: |
          echo "Contents of .lint-results/:"
          ls -la .lint-results/ 2>/dev/null || echo "Directory does not exist or is empty"

      - name: Upload Lint Artifacts
        if: always() && inputs.upload-artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.working-directory == '.' && format('{0}/.lint-results/', github.workspace) || format('{0}/{1}/.lint-results/', github.workspace, inputs.working-directory) }}
          retention-days: ${{ inputs.artifact-retention-days }}
          if-no-files-found: ignore
          include-hidden-files: true

      # Generate Summary
      - name: Generate Summary
        id: summary
        if: always()
        run: |
          echo "## Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Linter | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          OVERALL="success"

          # Python
          if [[ "${{ inputs.python }}" == "true" ]]; then
            if [[ "${{ steps.python-lint.outcome }}" == "success" ]]; then
              echo "| :snake: Python (ruff) | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| :snake: Python (ruff) | :x: Failed |" >> $GITHUB_STEP_SUMMARY
              OVERALL="failure"
            fi
          else
            echo "| :snake: Python (ruff) | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # Go
          if [[ "${{ inputs.go }}" == "true" ]]; then
            if [[ "${{ steps.go-lint.outcome }}" == "success" ]]; then
              echo "| :blue_square: Go (golangci-lint) | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| :blue_square: Go (golangci-lint) | :x: Failed |" >> $GITHUB_STEP_SUMMARY
              OVERALL="failure"
            fi
          else
            echo "| :blue_square: Go (golangci-lint) | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # Shell
          if [[ "${{ inputs.shell }}" == "true" ]]; then
            if [[ "${{ steps.shell-lint.outcome }}" == "success" ]]; then
              echo "| :shell: Shell (shellcheck) | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| :shell: Shell (shellcheck) | :x: Failed |" >> $GITHUB_STEP_SUMMARY
              OVERALL="failure"
            fi
          else
            echo "| :shell: Shell (shellcheck) | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # YAML
          if [[ "${{ inputs.yaml }}" == "true" ]]; then
            if [[ "${{ steps.yaml-lint.outcome }}" == "success" ]]; then
              echo "| :page_facing_up: YAML (yamllint) | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| :page_facing_up: YAML (yamllint) | :x: Failed |" >> $GITHUB_STEP_SUMMARY
              OVERALL="failure"
            fi
          else
            echo "| :page_facing_up: YAML (yamllint) | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # Helm
          if [[ "${{ inputs.helm }}" == "true" ]]; then
            if [[ "${{ steps.helm-lint.outcome }}" == "success" ]]; then
              echo "| :wheel_of_dharma: Helm | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| :wheel_of_dharma: Helm | :x: Failed |" >> $GITHUB_STEP_SUMMARY
              OVERALL="failure"
            fi
          else
            echo "| :wheel_of_dharma: Helm | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          # JSON
          if [[ "${{ inputs.json }}" == "true" ]]; then
            if [[ "${{ steps.json-lint.outcome }}" == "success" ]]; then
              echo "| :card_file_box: JSON (jq) | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| :card_file_box: JSON (jq) | :x: Failed |" >> $GITHUB_STEP_SUMMARY
              OVERALL="failure"
            fi
          else
            echo "| :card_file_box: JSON (jq) | :fast_forward: Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status:** $(if [[ "$OVERALL" == "success" ]]; then echo ':white_check_mark: All checks passed'; else echo ':x: Some checks failed'; fi)" >> $GITHUB_STEP_SUMMARY

          echo "status=$OVERALL" >> $GITHUB_OUTPUT

          # Fail the job if any linter failed
          if [[ "$OVERALL" == "failure" ]]; then
            exit 1
          fi
