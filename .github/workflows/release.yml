name: Release
# Reusable workflow for creating GitHub releases
# Pure Lego block - only handles release creation, not testing or building

on:
  workflow_call:
    inputs:
      # Release configuration
      release-tag:
        description: 'Tag name for the release (defaults to github.ref_name)'
        required: false
        type: string
        default: ''
      release-name:
        description: 'Release name (defaults to tag name)'
        required: false
        type: string
        default: ''
      release-notes:
        description: 'Custom release notes (overrides auto-generation)'
        required: false
        type: string
        default: ''
      release-notes-auto:
        description: 'Auto-generate release notes from commits'
        required: false
        type: boolean
        default: true
      release-draft:
        description: 'Create release as draft'
        required: false
        type: boolean
        default: false
      release-prerelease:
        description: 'Mark release as prerelease'
        required: false
        type: boolean
        default: false
      release-latest:
        description: 'Mark as latest release (true, false, or legacy)'
        required: false
        type: string
        default: 'true'

      # Artifact configuration
      artifact-pattern:
        description: 'Glob pattern for release artifacts to upload'
        required: false
        type: string
        default: ''
      artifact-retention-days:
        description: 'Number of days to retain artifacts'
        required: false
        type: number
        default: 90

      # Runner configuration
      runs-on:
        description: 'Runner label to use'
        required: false
        type: string
        default: 'ubuntu-latest'

    secrets:
      release-token:
        description: 'Token for creating releases (defaults to GITHUB_TOKEN)'
        required: false

    outputs:
      release-id:
        description: 'The ID of the created release'
        value: ${{ jobs.release.outputs.release-id }}
      release-url:
        description: 'The URL of the created release'
        value: ${{ jobs.release.outputs.release-url }}
      release-tag:
        description: 'The tag name of the release'
        value: ${{ jobs.release.outputs.release-tag }}

jobs:
  release:
    name: Create Release
    runs-on: ${{ inputs.runs-on }}
    permissions:
      contents: write
    outputs:
      release-id: ${{ steps.create-release.outputs.id }}
      release-url: ${{ steps.create-release.outputs.html_url }}
      release-tag: ${{ steps.release-tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine Release Tag
        id: release-tag
        run: |
          TAG="${{ inputs.release-tag }}"

          if [[ -z "$TAG" ]]; then
            TAG="${{ github.ref_name }}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Generate Release Notes
        id: release-notes
        run: |
          CUSTOM_NOTES="${{ inputs.release-notes }}"
          AUTO_GENERATE="${{ inputs.release-notes-auto }}"
          TAG="${{ steps.release-tag.outputs.tag }}"

          if [[ -n "$CUSTOM_NOTES" ]]; then
            echo "Using custom release notes"
            NOTES="$CUSTOM_NOTES"
          elif [[ "$AUTO_GENERATE" == "true" ]]; then
            echo "Auto-generating release notes"

            # Get previous tag
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

            if [[ -n "$PREV_TAG" ]]; then
              echo "Generating changelog from $PREV_TAG to $TAG"
              NOTES=$(git log --pretty=format:"- %s (%h)" "$PREV_TAG"..HEAD 2>/dev/null || echo "")
            else
              echo "No previous tag found, using recent commits"
              NOTES=$(git log --pretty=format:"- %s (%h)" -20 2>/dev/null || echo "")
            fi

            # Categorize commits
            FEATURES=$(echo "$NOTES" | grep -iE "^- (feat|feature)" || true)
            FIXES=$(echo "$NOTES" | grep -iE "^- fix" || true)
            OTHER=$(echo "$NOTES" | grep -viE "^- (feat|feature|fix)" || true)

            FORMATTED_NOTES=""
            if [[ -n "$FEATURES" ]]; then
              FORMATTED_NOTES+="## Features\n$FEATURES\n\n"
            fi
            if [[ -n "$FIXES" ]]; then
              FORMATTED_NOTES+="## Bug Fixes\n$FIXES\n\n"
            fi
            if [[ -n "$OTHER" ]]; then
              FORMATTED_NOTES+="## Other Changes\n$OTHER\n\n"
            fi

            if [[ -z "$FORMATTED_NOTES" ]]; then
              FORMATTED_NOTES="$NOTES"
            fi

            NOTES="$FORMATTED_NOTES"
          else
            NOTES=""
          fi

          # Write to file for gh release
          echo -e "$NOTES" > /tmp/release-notes.md

          echo "Release notes generated"

      - name: Upload Release Artifacts
        id: upload-artifacts
        if: inputs.artifact-pattern != ''
        uses: actions/upload-artifact@v6
        with:
          name: release-artifacts
          path: ${{ inputs.artifact-pattern }}
          retention-days: ${{ inputs.artifact-retention-days }}
          if-no-files-found: ignore

      - name: Create GitHub Release
        id: create-release
        env:
          GH_TOKEN: ${{ secrets.release-token || github.token }}
        run: |
          TAG="${{ steps.release-tag.outputs.tag }}"
          NAME="${{ inputs.release-name }}"
          DRAFT="${{ inputs.release-draft }}"
          PRERELEASE="${{ inputs.release-prerelease }}"
          LATEST="${{ inputs.release-latest }}"
          ARTIFACT_PATTERN="${{ inputs.artifact-pattern }}"

          # Build release name
          if [[ -z "$NAME" ]]; then
            NAME="$TAG"
          fi

          # Build gh release arguments
          ARGS=("--title" "$NAME")

          # Add notes file
          ARGS+=("--notes-file" "/tmp/release-notes.md")

          # Add flags
          if [[ "$DRAFT" == "true" ]]; then
            ARGS+=("--draft")
          fi

          if [[ "$PRERELEASE" == "true" ]]; then
            ARGS+=("--prerelease")
          fi

          if [[ "$LATEST" == "false" ]]; then
            ARGS+=("--latest=false")
          elif [[ "$LATEST" == "legacy" ]]; then
            # Don't set latest flag for legacy behavior
            true
          fi

          # Create release
          echo "Creating release for tag: $TAG"

          RELEASE_OUTPUT=$(gh release create "$TAG" "${ARGS[@]}" 2>&1) || {
            # Release might already exist, try to update it
            echo "Release may already exist, attempting to update..."
            RELEASE_OUTPUT=$(gh release edit "$TAG" --title "$NAME" --notes-file /tmp/release-notes.md 2>&1) || true
          }

          echo "$RELEASE_OUTPUT"

          # Get release info
          RELEASE_INFO=$(gh release view "$TAG" --json id,url 2>/dev/null || echo '{}')
          RELEASE_ID=$(echo "$RELEASE_INFO" | jq -r '.id // empty')
          RELEASE_URL=$(echo "$RELEASE_INFO" | jq -r '.url // empty')

          echo "id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "html_url=$RELEASE_URL" >> $GITHUB_OUTPUT

          # Upload artifacts if pattern specified
          if [[ -n "$ARTIFACT_PATTERN" ]]; then
            echo "Uploading release artifacts..."
            gh release upload "$TAG" $ARTIFACT_PATTERN --clobber 2>/dev/null || true
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "## GitHub Release Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RELEASE_URL="${{ steps.create-release.outputs.html_url }}"

          if [[ -n "$RELEASE_URL" ]]; then
            echo ":rocket: **Release Created Successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo ":warning: **Release Creation Status Unknown**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ steps.release-tag.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Name | \`${{ inputs.release-name || steps.release-tag.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Draft | ${{ inputs.release-draft }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prerelease | ${{ inputs.release-prerelease }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest | ${{ inputs.release-latest }} |" >> $GITHUB_STEP_SUMMARY

          if [[ -n "$RELEASE_URL" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo ":link: **[View Release]($RELEASE_URL)**" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "${{ inputs.artifact-pattern }}" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Pattern: \`${{ inputs.artifact-pattern }}\`" >> $GITHUB_STEP_SUMMARY
          fi
