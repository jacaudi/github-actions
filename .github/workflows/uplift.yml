name: Uplift Auto-Tagging
# Reusable workflow for automatic semantic versioning based on Conventional Commits
# Uses Uplift (https://uplift.dev) to analyze commit history and create version tags
#
# Usage with GitHub App authentication (recommended for triggering downstream workflows):
#   jobs:
#     release:
#       uses: your-org/github-actions/.github/workflows/uplift.yml@main
#       with:
#         use-github-app: ${{ secrets.APP_ID != '' && secrets.APP_PRIVATE_KEY != '' }}
#       secrets:
#         app-id: ${{ secrets.APP_ID }}
#         app-private-key: ${{ secrets.APP_PRIVATE_KEY }}
#
# Usage with GITHUB_TOKEN (simpler but won't trigger downstream workflows):
#   jobs:
#     release:
#       uses: your-org/github-actions/.github/workflows/uplift.yml@main

on:
  workflow_call:
    inputs:
      uplift-args:
        description: 'Uplift command arguments (release, tag, bump, changelog)'
        required: false
        type: string
        default: 'release'
      dry-run:
        description: 'Run in dry-run mode (no tags or changes committed)'
        required: false
        type: boolean
        default: false
      fetch-tags:
        description: 'Fetch all tags in addition to full history'
        required: false
        type: boolean
        default: true
      config-file:
        description: 'Path to Uplift configuration file'
        required: false
        type: string
        default: ''
      skip-changelog:
        description: 'Skip changelog generation'
        required: false
        type: boolean
        default: false
      skip-bumps:
        description: 'Skip file version bumps'
        required: false
        type: boolean
        default: false
      prerelease:
        description: 'Create a prerelease version with the given suffix (e.g., alpha, beta, rc)'
        required: false
        type: string
        default: ''
      runs-on:
        description: 'Runner label to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      use-github-app:
        description: 'Whether to use GitHub App authentication (set to true when providing app-id and app-private-key secrets)'
        required: false
        type: boolean
        default: false
    secrets:
      app-id:
        description: 'GitHub App ID for generating tokens (optional - uses GITHUB_TOKEN if not provided)'
        required: false
      app-private-key:
        description: 'GitHub App private key for generating tokens'
        required: false
    outputs:
      version:
        description: 'The new version that was created (empty if no release needed)'
        value: ${{ jobs.uplift.outputs.version }}
      previous-version:
        description: 'The previous version before this release'
        value: ${{ jobs.uplift.outputs.previous-version }}
      changelog:
        description: 'The generated changelog content'
        value: ${{ jobs.uplift.outputs.changelog }}
      released:
        description: 'Whether a new version was released (true/false)'
        value: ${{ jobs.uplift.outputs.released }}

jobs:
  uplift:
    name: Semantic Version Release
    runs-on: ${{ inputs.runs-on }}
    permissions:
      contents: write
    outputs:
      version: ${{ steps.uplift.outputs.version }}
      previous-version: ${{ steps.uplift.outputs.previousVersion }}
      changelog: ${{ steps.uplift.outputs.changelog }}
      released: ${{ steps.check-release.outputs.released }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          # CRITICAL: fetch-depth: 0 is required for Uplift to analyze full git history
          fetch-depth: 0
          fetch-tags: ${{ inputs.fetch-tags }}

      - name: Validate git history
        run: |
          echo "Checking git history..."
          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
          TAG_COUNT=$(git tag -l | wc -l | tr -d ' ')

          echo "Total commits: ${COMMIT_COUNT}"
          echo "Total tags: ${TAG_COUNT}"

          if [[ "${COMMIT_COUNT}" == "0" ]]; then
            echo "::warning::No commits found in repository"
          fi

          # List recent commits for visibility
          echo ""
          echo "Recent commits:"
          git log --oneline -10 || true

          # List existing tags
          if [[ "${TAG_COUNT}" != "0" ]]; then
            echo ""
            echo "Existing version tags:"
            git tag -l 'v*' --sort=-v:refname | head -5 || true
          fi

      - name: Generate GitHub App Token
        id: app-token
        if: ${{ inputs.use-github-app }}
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.app-id }}
          private-key: ${{ secrets.app-private-key }}

      - name: Determine token to use
        id: token
        run: |
          if [[ -n "${{ steps.app-token.outputs.token }}" ]]; then
            echo "Using GitHub App token (will trigger downstream workflows)"
            echo "token=${{ steps.app-token.outputs.token }}" >> $GITHUB_OUTPUT
            echo "token-type=app" >> $GITHUB_OUTPUT
          else
            echo "Using GITHUB_TOKEN (will NOT trigger downstream workflows)"
            echo "token=${{ github.token }}" >> $GITHUB_OUTPUT
            echo "token-type=github" >> $GITHUB_OUTPUT
          fi

      - name: Build Uplift arguments
        id: args
        run: |
          ARGS="${{ inputs.uplift-args }}"

          # Add dry-run flag
          if [[ "${{ inputs.dry-run }}" == "true" ]]; then
            ARGS="${ARGS} --dry-run"
          fi

          # Add config file
          if [[ -n "${{ inputs.config-file }}" ]]; then
            ARGS="${ARGS} --config ${{ inputs.config-file }}"
          fi

          # Add skip flags
          if [[ "${{ inputs.skip-changelog }}" == "true" ]]; then
            ARGS="${ARGS} --no-changelog"
          fi

          if [[ "${{ inputs.skip-bumps }}" == "true" ]]; then
            ARGS="${ARGS} --no-bump"
          fi

          # Add prerelease suffix
          if [[ -n "${{ inputs.prerelease }}" ]]; then
            ARGS="${ARGS} --prerelease ${{ inputs.prerelease }}"
          fi

          echo "Uplift arguments: ${ARGS}"
          echo "args=${ARGS}" >> $GITHUB_OUTPUT

      - name: Run Uplift
        id: uplift
        uses: gembaadvantage/uplift-action@v2
        with:
          args: ${{ steps.args.outputs.args }}
        env:
          GITHUB_TOKEN: ${{ steps.token.outputs.token }}

      - name: Check if release was created
        id: check-release
        run: |
          if [[ -n "${{ steps.uplift.outputs.version }}" ]]; then
            echo "released=true" >> $GITHUB_OUTPUT
            echo "New version created: ${{ steps.uplift.outputs.version }}"
          else
            echo "released=false" >> $GITHUB_OUTPUT
            echo "No new version created (no qualifying commits since last release)"
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "## Uplift Auto-Tagging Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status badge
          if [[ "${{ steps.check-release.outputs.released }}" == "true" ]]; then
            echo ":rocket: **New Version Released**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ inputs.dry-run }}" == "true" ]]; then
            echo ":test_tube: **Dry Run Mode** - No changes made" >> $GITHUB_STEP_SUMMARY
          else
            echo ":information_source: **No Release Needed** - No qualifying commits found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY

          if [[ -n "${{ steps.uplift.outputs.version }}" ]]; then
            echo "| New Version | \`${{ steps.uplift.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| New Version | _None_ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "${{ steps.uplift.outputs.previousVersion }}" ]]; then
            echo "| Previous Version | \`${{ steps.uplift.outputs.previousVersion }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Previous Version | _None_ |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| Dry Run | ${{ inputs.dry-run }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Token Type | ${{ steps.token.outputs.token-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Uplift Command | \`${{ steps.args.outputs.args }}\` |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Changelog | ${{ inputs.skip-changelog }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Bumps | ${{ inputs.skip-bumps }} |" >> $GITHUB_STEP_SUMMARY

          if [[ -n "${{ inputs.prerelease }}" ]]; then
            echo "| Prerelease | \`${{ inputs.prerelease }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Prerelease | _No_ |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -n "${{ inputs.config-file }}" ]]; then
            echo "| Config File | \`${{ inputs.config-file }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Config File | _Default (.uplift.yml)_ |" >> $GITHUB_STEP_SUMMARY
          fi

          # Token warning
          if [[ "${{ steps.token.outputs.token-type }}" == "github" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> :warning: **Note:** Using GITHUB_TOKEN. Tags created by this workflow will NOT trigger other workflows." >> $GITHUB_STEP_SUMMARY
            echo "> To trigger downstream workflows, provide \`app-id\` and \`app-private-key\` secrets." >> $GITHUB_STEP_SUMMARY
          fi

          # Changelog preview
          if [[ -n "${{ steps.uplift.outputs.changelog }}" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changelog" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.uplift.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          fi
