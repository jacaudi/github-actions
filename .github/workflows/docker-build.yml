name: Docker Build
# Reusable workflow for multi-arch Docker image builds using the docker composite action

on:
  workflow_call:
    inputs:
      registry:
        description: 'Container registry (e.g., ghcr.io, docker.io)'
        required: false
        type: string
        default: 'ghcr.io'
      image-name:
        description: 'Image name (e.g., owner/repo). Defaults to repository name'
        required: false
        type: string
        default: ''
      platforms:
        description: 'Target platforms for multi-arch builds (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      push:
        description: 'Push image to registry after build'
        required: false
        type: boolean
        default: true
      context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'
      file:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      build-args:
        description: 'Build arguments (newline-separated KEY=VALUE pairs)'
        required: false
        type: string
        default: ''
      tags:
        description: 'Custom tags (newline-separated, overrides auto-generated tags)'
        required: false
        type: string
        default: ''
      labels:
        description: 'Custom labels (newline-separated KEY=VALUE pairs)'
        required: false
        type: string
        default: ''
      cache-from:
        description: 'Cache sources (e.g., type=gha, type=registry,ref=...)'
        required: false
        type: string
        default: 'type=gha'
      cache-to:
        description: 'Cache destinations (e.g., type=gha,mode=max)'
        required: false
        type: string
        default: 'type=gha,mode=max'
      provenance:
        description: 'Generate provenance attestation'
        required: false
        type: boolean
        default: true
      registry-username:
        description: 'Registry username (defaults to github.actor for ghcr.io)'
        required: false
        type: string
        default: ''
      amd64-runner:
        description: 'Runner label for AMD64 builds'
        required: false
        type: string
        default: 'ubuntu-24.04'
      arm64-runner:
        description: 'Runner label for ARM64 builds'
        required: false
        type: string
        default: 'ubuntu-24.04-arm'
      runs-on:
        description: 'DEPRECATED: Use amd64-runner instead. Runner label for single-arch builds.'
        required: false
        type: string
        default: 'ubuntu-24.04'
    secrets:
      registry-password:
        description: 'Registry password/token (defaults to GITHUB_TOKEN for ghcr.io)'
        required: false
    outputs:
      imageid:
        description: 'Image ID'
        value: ${{ jobs.merge.outputs.imageid || jobs.build.outputs.imageid }}
      digest:
        description: 'Image digest'
        value: ${{ jobs.merge.outputs.digest || jobs.build.outputs.digest }}
      metadata:
        description: 'Build result metadata'
        value: ${{ jobs.merge.outputs.metadata || jobs.build.outputs.metadata }}
      tags:
        description: 'Generated tags'
        value: ${{ jobs.merge.outputs.tags || jobs.build.outputs.tags }}
      labels:
        description: 'Generated labels'
        value: ${{ jobs.merge.outputs.labels || jobs.build.outputs.labels }}
      version:
        description: 'Generated version'
        value: ${{ jobs.merge.outputs.version || jobs.build.outputs.version }}

jobs:
  # Validate platforms and determine build strategy
  validate:
    name: Validate Platforms
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.parse.outputs.platforms }}
      strategy: ${{ steps.parse.outputs.strategy }}
      matrix: ${{ steps.parse.outputs.matrix }}
    steps:
      - name: Parse platforms
        id: parse
        run: |
          PLATFORMS="${{ inputs.platforms }}"

          # Check for empty input
          if [[ -z "${PLATFORMS}" ]]; then
            echo "::error::Platforms input is required"
            exit 1
          fi

          # Normalize: remove spaces, lowercase, remove trailing commas
          PLATFORMS=$(echo "${PLATFORMS}" | tr -d ' ' | tr '[:upper:]' '[:lower:]' | sed 's/,$//')

          # Validate each platform
          IFS=',' read -ra PLATFORM_ARRAY <<< "${PLATFORMS}"
          VALID_PLATFORMS=("linux/amd64" "linux/arm64")

          # Deduplicate platforms
          PLATFORM_ARRAY=($(printf '%s\n' "${PLATFORM_ARRAY[@]}" | sort -u))

          for platform in "${PLATFORM_ARRAY[@]}"; do
            if [[ -z "${platform}" ]]; then
              continue  # Skip empty entries
            fi
            if [[ ! " ${VALID_PLATFORMS[*]} " =~ " ${platform} " ]]; then
              echo "::error::Unsupported platform: ${platform}. Only linux/amd64 and linux/arm64 are supported."
              exit 1
            fi
          done

          # Determine strategy
          PLATFORM_COUNT=${#PLATFORM_ARRAY[@]}

          if [[ ${PLATFORM_COUNT} -eq 1 ]]; then
            echo "strategy=single" >> "$GITHUB_OUTPUT"
            echo "platforms=${PLATFORM_ARRAY[0]}" >> "$GITHUB_OUTPUT"

            # Single platform matrix
            if [[ "${PLATFORM_ARRAY[0]}" == "linux/amd64" ]]; then
              echo 'matrix={"include":[{"platform":"linux/amd64","runner":"'"${{ inputs.amd64-runner }}"'"}]}' >> "$GITHUB_OUTPUT"
            else
              echo 'matrix={"include":[{"platform":"linux/arm64","runner":"'"${{ inputs.arm64-runner }}"'"}]}' >> "$GITHUB_OUTPUT"
            fi
          elif [[ ${PLATFORM_COUNT} -eq 2 ]]; then
            echo "strategy=multi" >> "$GITHUB_OUTPUT"
            echo "platforms=linux/amd64,linux/arm64" >> "$GITHUB_OUTPUT"
            echo 'matrix={"include":[{"platform":"linux/amd64","runner":"'"${{ inputs.amd64-runner }}"'"},{"platform":"linux/arm64","runner":"'"${{ inputs.arm64-runner }}"'"}]}' >> "$GITHUB_OUTPUT"
          else
            echo "::error::Invalid platform configuration"
            exit 1
          fi

          echo "Platforms: ${PLATFORM_ARRAY[*]}"
          echo "Strategy: $(grep strategy "$GITHUB_OUTPUT" | cut -d= -f2)"

  # Build images natively on platform-specific runners
  build:
    name: Build (${{ matrix.platform }})
    needs: validate
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.validate.outputs.matrix) }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.single-output.outputs.digest || '' }}
      imageid: ${{ steps.single-output.outputs.imageid || '' }}
      metadata: ${{ steps.single-output.outputs.metadata || '' }}
      tags: ${{ inputs.tags || steps.meta.outputs.tags }}
      labels: ${{ steps.meta.outputs.labels }}
      version: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Determine image name
        id: image-name
        run: |
          if [[ -n "${{ inputs.image-name }}" ]]; then
            echo "name=${{ inputs.image-name }}" >> $GITHUB_OUTPUT
          else
            echo "name=${{ github.repository }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ inputs.registry-username || github.actor }}
          password: ${{ secrets.registry-password || github.token }}

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.registry }}/${{ steps.image-name.outputs.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-

      # Single platform: push with tags directly
      - name: Build and Push (single platform)
        id: build-single
        if: needs.validate.outputs.strategy == 'single'
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.file }}
          platforms: ${{ matrix.platform }}
          push: ${{ inputs.push }}
          tags: ${{ inputs.tags || steps.meta.outputs.tags }}
          labels: ${{ inputs.labels || steps.meta.outputs.labels }}
          build-args: ${{ inputs.build-args }}
          cache-from: ${{ inputs.cache-from }}
          cache-to: ${{ inputs.cache-to }}
          provenance: ${{ inputs.provenance }}

      # Multi platform: push by digest for later merge
      - name: Build and Push (multi platform)
        id: build-multi
        if: needs.validate.outputs.strategy == 'multi'
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.file }}
          platforms: ${{ matrix.platform }}
          labels: ${{ inputs.labels || steps.meta.outputs.labels }}
          build-args: ${{ inputs.build-args }}
          cache-from: ${{ inputs.cache-from }}
          cache-to: ${{ inputs.cache-to }}
          provenance: ${{ inputs.provenance }}
          outputs: type=image,name=${{ inputs.registry }}/${{ steps.image-name.outputs.name }},push-by-digest=true,name-canonical=true,push=${{ inputs.push }}

      - name: Export digest (multi platform)
        if: needs.validate.outputs.strategy == 'multi' && inputs.push == true
        run: |
          mkdir -p /tmp/digests
          DIGEST="${{ steps.build-multi.outputs.digest }}"
          PLATFORM="${{ matrix.platform }}"
          ARCH="${PLATFORM#linux/}"
          echo "${DIGEST}" > "/tmp/digests/${ARCH}"
          echo "Saved digest for ${ARCH}: ${DIGEST}"

      - name: Upload digest artifact
        if: needs.validate.outputs.strategy == 'multi' && inputs.push == true
        uses: actions/upload-artifact@v6
        with:
          name: digest-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

      # Set outputs for single platform builds
      - name: Set outputs (single platform)
        id: single-output
        if: needs.validate.outputs.strategy == 'single'
        run: |
          echo "digest=${{ steps.build-single.outputs.digest }}" >> $GITHUB_OUTPUT
          echo "imageid=${{ steps.build-single.outputs.imageid }}" >> $GITHUB_OUTPUT
          echo "metadata=${{ steps.build-single.outputs.metadata }}" >> $GITHUB_OUTPUT

      - name: Generate Summary (single platform)
        if: needs.validate.outputs.strategy == 'single'
        run: |
          echo "## Docker Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":white_check_mark: **Build Successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | \`${{ inputs.registry }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ steps.image-name.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | \`${{ matrix.platform }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Runner | \`${{ matrix.runner }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ steps.build-single.outputs.digest }}" ]]; then
            echo "**Digest:** \`${{ steps.build-single.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          fi

  # Merge platform images into multi-arch manifest (only for multi-platform builds)
  merge:
    name: Create Multi-arch Manifest
    if: needs.validate.outputs.strategy == 'multi' && inputs.push == true
    needs: [validate, build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      digest: ${{ steps.inspect.outputs.digest }}
      imageid: ${{ steps.inspect.outputs.imageid }}
      metadata: ${{ steps.inspect.outputs.metadata }}
      tags: ${{ inputs.tags || steps.meta.outputs.tags }}
      labels: ${{ steps.meta.outputs.labels }}
      version: ${{ steps.meta.outputs.version }}
    steps:
      - name: Determine image name
        id: image-name
        run: |
          if [[ -n "${{ inputs.image-name }}" ]]; then
            echo "name=${{ inputs.image-name }}" >> $GITHUB_OUTPUT
          else
            echo "name=${{ github.repository }}" >> $GITHUB_OUTPUT
          fi

      - name: Download digests
        uses: actions/download-artifact@v7
        with:
          path: /tmp/digests
          pattern: digest-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ inputs.registry-username || github.actor }}
          password: ${{ secrets.registry-password || github.token }}

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.registry }}/${{ steps.image-name.outputs.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          IMAGE="${{ inputs.registry }}/${{ steps.image-name.outputs.name }}"

          # Read digests
          AMD64_DIGEST=$(cat amd64 2>/dev/null || echo "")
          ARM64_DIGEST=$(cat arm64 2>/dev/null || echo "")

          echo "AMD64 digest: ${AMD64_DIGEST}"
          echo "ARM64 digest: ${ARM64_DIGEST}"

          # Build tag arguments - use custom tags if provided, otherwise metadata tags
          TAGS="${{ inputs.tags || steps.meta.outputs.tags }}"
          TAGARGS=""
          while IFS= read -r tag; do
            [[ -n "${tag}" ]] && TAGARGS="${TAGARGS} --tag ${tag}"
          done <<< "${TAGS}"

          # Create and push multi-arch manifest
          docker buildx imagetools create ${TAGARGS} \
            "${IMAGE}@${AMD64_DIGEST}" \
            "${IMAGE}@${ARM64_DIGEST}"

      - name: Inspect manifest
        id: inspect
        run: |
          IMAGE="${{ inputs.registry }}/${{ steps.image-name.outputs.name }}"
          TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -1)

          DIGEST=$(docker buildx imagetools inspect "${TAG}" --format '{{json .Manifest.Digest}}' | tr -d '"')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "imageid=${DIGEST}" >> $GITHUB_OUTPUT

          METADATA=$(docker buildx imagetools inspect "${TAG}" --format '{{json .}}' | jq -c .)
          echo "metadata=${METADATA}" >> $GITHUB_OUTPUT

      - name: Generate Summary
        run: |
          echo "## Docker Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":white_check_mark: **Multi-arch Build Successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | \`${{ inputs.registry }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ steps.image-name.outputs.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platforms | \`linux/amd64, linux/arm64\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | Native runners (parallel) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.inspect.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
